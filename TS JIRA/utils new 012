public class Utils {

    // Logger Initialization for Utils Class
    private static final Logger logger = LogManager.getLogger();

    /* Create a method to establish a Jira connection. This method has two String arguments as "url" and "apiKey"
     * ClosableHttpClient class is used to perform this operation instead of HttpClient, so that a separate method is not required to close the connection each time.
     * This method returns CloseableHttpClient's object instance once the connection is established */
    public static HttpEntity getJiraResponse(String url, String apiKey) {
        CloseableHttpClient connection = HttpClients.createDefault();
        HttpGet request = new HttpGet(url);
        request.setHeader("Authorization", "Bearer " + apiKey);
        request.setHeader("Accept", "application/json");
        HttpResponse response = null;
        try {
            response = connection.execute(request);
        } catch (ClientProtocolException e) {
            logger.error("Error occurred in Jira connection", e);
        } catch (IOException e) {
            logger.error("Error occurred in Jira connection", e);
        }
        HttpEntity entity = response.getEntity();
        if (entity != null) {
            logger.info("Successfully returned HttpEntity response");
            return entity;
        } else {
            logger.error("Error occurred. HttpEntity is null and no response is received.");
            return null;
        }
    }

    /* Create a method to find or create a tag in Rally. This method checks if a tag already exists and creates it if not. */
    public static JsonObject findOrCreateTag(RallyRestApi restApi, String tagName) throws IOException {
        // Check if the tag already exists
        QueryRequest tagRequest = new QueryRequest("Tag");
        tagRequest.setQueryFilter(new QueryFilter("Name", "=", tagName));
        QueryResponse tagResponse = restApi.query(tagRequest);

        if (tagResponse.getResults().size() > 0) {
            return tagResponse.getResults().get(0).getAsJsonObject();
        }

        // If the tag doesn't exist, create it
        JsonObject newTag = new JsonObject();
        newTag.addProperty("Name", tagName);

        CreateRequest createTagRequest = new CreateRequest("Tag", newTag);
        CreateResponse createTagResponse = restApi.create(createTagRequest);

        if (createTagResponse.wasSuccessful()) {
            return createTagResponse.getObject();
        } else {
            logger.error("Error occurred creating tag:");
            for (String error : createTagResponse.getErrors()) {
                logger.error(error);
            }
            return null;
        }
    }

    /* Check if the Jira folder structure is available in Rally
     * a. If folder structure is not available in Rally, then create the same Jira folder structure in Rally for the testcase 
     * b. If folder structure is available in Rally, no action is required */
    public static JsonObject createTestFolder(String[] folderHierarchy, String projectRef, String rallyBaseUrl, String rallyApiKey) {
        JsonObject lastFolder = null;
        String lastFolderRef = null;

        RallyRestApi restApi = null;
        try {
            restApi = new RallyRestApi(new URI(rallyBaseUrl), rallyApiKey);
            restApi.setApplicationName("CreateTestCaseApp");

            for (int i = 0; i < folderHierarchy.length; i++) {
                String folderName = folderHierarchy[i];
                if (folderName == null || folderName.trim().isEmpty()) {
                    logger.info("Invalid folder name encountered: '" + folderName + "'");
                    continue;
                }

                // If it's the top-level folder, ensure it is created as a parent folder
                if (i == 0) {
                    // Check if the folder exists as a parent folder
                    QueryRequest parentFolderExistenceRequest = new QueryRequest("testfolder");
                    parentFolderExistenceRequest.setQueryFilter(new QueryFilter("Name", "=", folderName.trim()).and(new QueryFilter("Parent", "=", "null")));
                    parentFolderExistenceRequest.setFetch(new Fetch("_ref", "Name", "Parent"));

                    QueryResponse parentQueryResponse = restApi.query(parentFolderExistenceRequest);

                    if (parentQueryResponse.wasSuccessful() && parentQueryResponse.getTotalResultCount() > 0) {
                        // Folder exists as a parent folder
                        lastFolder = parentQueryResponse.getResults().get(0).getAsJsonObject();
                        lastFolderRef = lastFolder.get("_ref").getAsString();
                        logger.info("Parent folder already exists: " + lastFolderRef);
                    } else {
                        // Folder does not exist as a parent folder, create it
                        JsonObject newFolder = new JsonObject();
                        newFolder.addProperty("Name", folderName.trim());
                        newFolder.addProperty("Project", projectRef);

                        CreateRequest createFolderRequest = new CreateRequest("testfolder", newFolder);
                        CreateResponse createFolderResponse = restApi.create(createFolderRequest);

                        if (createFolderResponse.wasSuccessful()) {
                            lastFolderRef = createFolderResponse.getObject().get("_ref").getAsString();
                            newFolder.addProperty("_ref", lastFolderRef);
                            lastFolder = newFolder;
                            logger.info("Successfully created parent folder: " + lastFolderRef);
                        } else {
                            logger.error("Error occurred creating parent folder.");
                            for (String error : createFolderResponse.getErrors()) {
                                logger.error(error);
                            }
                            break;
                        }
                    }
                } else {
                    // For subfolders, check and create under the last folder
                    QueryRequest subFolderExistenceRequest = new QueryRequest("testfolder");
                    subFolderExistenceRequest.setQueryFilter(new QueryFilter("Name", "=", folderName.trim()).and(new QueryFilter("Parent", "=", lastFolderRef)));
                    subFolderExistenceRequest.setFetch(new Fetch("_ref", "Name", "Parent"));

                    QueryResponse subQueryResponse = restApi.query(subFolderExistenceRequest);

                    if (subQueryResponse.wasSuccessful() && subQueryResponse.getTotalResultCount() > 0) {
                        // Folder exists as a subfolder
                        lastFolder = subQueryResponse.getResults().get(0).getAsJsonObject();
                        lastFolderRef = lastFolder.get("_ref").getAsString();
                        logger.info("Subfolder already exists: " + lastFolderRef);
                    } else {
                        // Folder does not exist, create it as a subfolder
                        JsonObject newFolder = new JsonObject();
                        newFolder.addProperty("Name", folderName.trim());
                        newFolder.addProperty("Project", projectRef);
                        newFolder.addProperty("Parent", lastFolderRef);

                        CreateRequest createFolderRequest = new CreateRequest("testfolder", newFolder);
                        CreateResponse createFolderResponse = restApi.create(createFolderRequest);

                        if (createFolderResponse.wasSuccessful()) {
                            lastFolderRef = createFolderResponse.getObject().get("_ref").getAsString();
                            newFolder.addProperty("_ref", lastFolderRef);
                            lastFolder = newFolder;
                            logger.info("Successfully created subfolder: " + lastFolderRef);
                        } else {
                            logger.error("Error occurred creating subfolder");
                            for (String error : createFolderResponse.getErrors()) {
                                logger.error(error);
                            }
                            break;
                        }
                    }
                }
            }

            return lastFolder;

        } catch (Exception e) {
            logger.error("Exception occurred while creating test folder", e);
            return null;
        } finally {
            if (restApi != null) {
                try {
                    restApi.close();
                } catch (Exception e) {
                    logger.error("Exception occurred while closing RallyRestApi", e);
                }
            }
        }
    }

    /* Method to add attachment to a test step in Rally */
    public static void addAttachmentToTestStep(RallyRestApi restApi, JsonObject testStepJson, String testStepRef, String attachmentLocation, String jiraApiKey) {
        // Get attachments from the test step JSON
        JsonArray attachmentsArray = testStepJson.getAsJsonArray("attachments");
        if (attachmentsArray != null) {
            for (JsonElement attachmentElement : attachmentsArray) {
                JsonObject attachmentObject = attachmentElement.getAsJsonObject();
                String fileName = attachmentObject.get("filename").getAsString();
                String fileUrl = attachmentObject.get("content").getAsString();

                // Download the attachment
                File attachmentFile = new File(attachmentLocation + "/" + fileName);
                try (InputStream inputStream = getJiraResponse(fileUrl, jiraApiKey).getContent();
                     FileOutputStream outputStream = new FileOutputStream(attachmentFile)) {

                    byte[] buffer = new byte[1024];
                    int bytesRead;
                    while ((bytesRead = inputStream.read(buffer)) != -1) {
                        outputStream.write(buffer, 0, bytesRead);
                    }
                    logger.info("Downloaded attachment: " + fileName);
                    
                    // Upload the attachment to Rally
                    byte[] fileContent = Files.readAllBytes(Paths.get(attachmentFile.getAbsolutePath()));
                    JsonObject attachmentJson = new JsonObject();
                    attachmentJson.addProperty("Name", fileName);

                    CreateRequest createRequest = new CreateRequest("Attachment", attachmentJson);
                    createRequest.setData(fileContent);
                    createRequest.setContentType("application/octet-stream");
                    createRequest.setFileName(fileName);

                    CreateResponse createResponse = restApi.create(createRequest);
                    if (createResponse.wasSuccessful()) {
                        JsonObject uploadedAttachment = createResponse.getObject();
                        String attachmentRef = uploadedAttachment.get("_ref").getAsString();
                        
                        // Add the uploaded attachment to the test step in Rally
                        JsonObject testStepUpdate = new JsonObject();
                        testStepUpdate.addProperty("_ref", testStepRef);
                        JsonArray newAttachmentsArray = new JsonArray();
                        newAttachmentsArray.add(attachmentRef);
                        testStepUpdate.add("Attachments", newAttachmentsArray);
                        
                        CreateRequest updateRequest = new CreateRequest("TestStep", testStepUpdate);
                        CreateResponse updateResponse = restApi.update(updateRequest);
                        if (updateResponse.wasSuccessful()) {
                            logger.info("Attached file to test step: " + fileName);
                        } else {
                            logger.error("Failed to attach file to test step: " + fileName);
                        }
                    } else {
                        logger.error("Failed to upload file: " + fileName);
                    }

                } catch (IOException e) {
                    logger.error("IOException occurred while handling attachment: " + fileName, e);
                }
            }
        }
    }

    // Implementation to update the TestCase Migrated in Jira to "true". User story US7382197
    public void updateTestCaseMigratedStatusinJira(boolean status) {
        // Method implementation here
    }
}
